
<div class="beige-noise">
  <div class="p-wrapper">
    <div class="container"></div>
    <div class="row">
      <div class="col-sm-12">
        <section id="exports">
          <h1>exports</h1>
          <h5 class="subheader"></h5>
          <p>
            <!--mixin labelForSymbolType(symbol)--><span class="label label-info radius ctx-type">method</span><span>module.exports()</span><span title="return value" class="glyphicon glyphicon-arrow-right"></span><span>Object</span>
          </p>
        </section>
        <div class="bs-example">
          <table class="table">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>baboon</td>
                <td>!Object</td>
                <td>The baboon object.</td>
              </tr>
            </tbody>
          </table>
        </div>
        <tabset>
          <tab heading="Description">
            <div class="well"><p>The transport module.</p>
            </div>
          </tab>
          <tab heading="Source">
            <div hljs="hljs">module.exports = function (baboon) {
    if (!baboon || !baboon.config) {
        throw new TransportError(400, '', 'Parameter baboon with baboon.config is required!');
    }

    var pub = {},
        PATH_API = 'api/',
        CONTROLLER_FILES = '
            </div>
          </tab>
        </tabset>
        <hr/>
        <section id="checkUserHasAccessTo">
          <h1>checkUserHasAccessTo</h1>
          <h5 class="subheader"></h5>
          <p>
            <!--mixin labelForSymbolType(symbol)--><span class="label label-info radius ctx-type">function</span><span>checkUserHasAccessTo()</span><span title="return value" class="glyphicon glyphicon-arrow-right"></span><span>Object</span>
          </p>
        </section>
        <div class="bs-example">
          <table class="table">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>user</td>
                <td>?Object</td>
                <td>The user object</td>
              </tr>
              <tr>
                <td>acl</td>
                <td>?Object</td>
                <td>The users acl</td>
              </tr>
              <tr>
                <td>route</td>
                <td>!String</td>
                <td>The route to check access to</td>
              </tr>
            </tbody>
          </table>
        </div>
        <tabset>
          <tab heading="Description">
            <div class="well"><p>/controllers/<em>.js',<br />        STRIP_COMMENTS = /((\/\/.</em>$)|(\/*[\s\S]*?*\/))/mg;</p>

<pre><code>var useRightSystem = (baboon.config.rights || {}).enabled || false;

/**
</code></pre>

<p>Checks wether the user has access to a route or not</p>
            </div>
          </tab>
          <tab heading="Source">
            <div hljs="hljs">function checkUserHasAccessTo(user, acl, route) {
        // delete PATH_API from route
        route = route.slice(PATH_API.length);

        // right system is disabled or system routes
        if ((!useRightSystem) || (route.indexOf('navigation') === 0) || (route.indexOf('session') === 0)) {
            return true;
        }

        if (user) {
            // check in rights if user has access to
            return baboon.rights.userHasAccessTo(user, route);
        }

        if (acl) {
            // check if route is in users acl
            return ((acl[route] || {}).hasAccess || false);
        }

        // no user or acl
        return false;
    }
            </div>
          </tab>
        </tabset>
        <hr/>
        <section id="getParamNames">
          <h1>getParamNames</h1>
          <h5 class="subheader"></h5>
          <p>
            <!--mixin labelForSymbolType(symbol)--><span class="label label-info radius ctx-type">function</span><span>getParamNames()</span><span title="return value" class="glyphicon glyphicon-arrow-right"></span><span>Array index:</span>
          </p>
        </section>
        <div class="bs-example">
          <table class="table">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td></td>
                <td>func</td>
                <td></td>
              </tr>
            </tbody>
          </table>
        </div>
        <tabset>
          <tab heading="Description">
            <div class="well"><p>Returns the function parameters as strings in an array</p>
            </div>
          </tab>
          <tab heading="Source">
            <div hljs="hljs">function getParamNames(func) {
        var fnStr = func.toString().replace(STRIP_COMMENTS, '');
        return fnStr.slice(fnStr.indexOf('(') + 1, fnStr.indexOf(')')).match(/([^\s,]+)/g) || [];
    }
            </div>
          </tab>
        </tabset>
        <hr/>
        <section id="getControllerPath">
          <h1>getControllerPath</h1>
          <h5 class="subheader"></h5>
          <p>
            <!--mixin labelForSymbolType(symbol)--><span class="label label-info radius ctx-type">function</span><span>getControllerPath()</span><span title="return value" class="glyphicon glyphicon-arrow-right"></span><span>Object</span>
          </p>
        </section>
        <div class="bs-example">
          <table class="table">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>fullPathToControllerFile</td>
                <td>String</td>
                <td></td>
              </tr>
              <tr>
                <td>separator</td>
                <td>String</td>
                <td></td>
              </tr>
              <tr>
                <td>controllerDirectory</td>
                <td>String</td>
                <td></td>
              </tr>
            </tbody>
          </table>
        </div>
        <tabset>
          <tab heading="Description">
            <div class="well"><p>Return the controller path for the route</p>
            </div>
          </tab>
          <tab heading="Source">
            <div hljs="hljs">function getControllerPath(fullPathToControllerFile, separator, controllerDirectory) {
        var modulePath = '';
        var splittedFile = fullPathToControllerFile.split(separator);

        // get controller name and remove '.js' from file name
        var controllerName = splittedFile.pop().slice(0, -3);

        // remove controllerName
        splittedFile.pop();

        var moduleName = splittedFile.pop();
        var i = splittedFile.length - 1;

        if (splittedFile.indexOf(controllerDirectory) === -1) {
            // no modulename found, therefore modulename = controllerDirectory and
            // controllerDirectory not anymore in splittedFile
            return null;
        }

        while (splittedFile[i] !== controllerDirectory) {
            modulePath = splittedFile[i] + '/' + modulePath;
            i--;
        }

        return modulePath + moduleName + '/' + controllerName;
    }
            </div>
          </tab>
        </tabset>
        <hr/>
        <section id="initAppControllers">
          <h1>initAppControllers</h1>
          <h5 class="subheader"></h5>
          <p>
            <!--mixin labelForSymbolType(symbol)--><span class="label label-info radius ctx-type">function</span><span>initAppControllers()</span><span title="return value" class="glyphicon glyphicon-arrow-right"></span><span>Object</span>
          </p>
        </section>
        <tabset>
          <tab heading="Description">
            <div class="well"><p>Indexes all controller files and their actions into the controllers list</p>
            </div>
          </tab>
          <tab heading="Source">
            <div hljs="hljs">function initAppControllers() {
        var grunt = require('grunt');

        // modules
        var patternControllers = baboon.config.path.modules + CONTROLLER_FILES,
            controllers = grunt.file.expand(patternControllers),
            result = {};

        lxHelpers.forEach(controllers, function (controllerFile) {
            // get controller path, e.g. app/blog/blog
            var controllerPath = getControllerPath(controllerFile, '/', 'modules');

            if (controllerPath) {
                // init controller and store in result
                result[PATH_API + controllerPath] = require(controllerFile)(baboon);
            }
        });

        return result;
    }

    var controllers = initAppControllers();
            </div>
          </tab>
        </tabset>
        <hr/>
        <section id="parseRoute">
          <h1>parseRoute</h1>
          <h5 class="subheader"></h5>
          <p>
            <!--mixin labelForSymbolType(symbol)--><span class="label label-info radius ctx-type">function</span><span>parseRoute()</span><span title="return value" class="glyphicon glyphicon-arrow-right"></span><span>action:</span>
          </p>
        </section>
        <div class="bs-example">
          <table class="table">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>route</td>
                <td>String</td>
                <td></td>
              </tr>
            </tbody>
          </table>
        </div>
        <tabset>
          <tab heading="Description">
            <div class="well"><p>Parses the route and returns action, controller, path</p>
            </div>
          </tab>
          <tab heading="Source">
            <div hljs="hljs">function parseRoute(route) {
        var parts = route.split('/');

        return {
            action: parts.pop(),
            controllerName: parts[parts.length - 1],
            controllerFullPath: parts.join('/')
        };
    }
            </div>
          </tab>
        </tabset>
        <hr/>
        <section id="getControllers">
          <h1>getControllers</h1>
          <h5 class="subheader"></h5>
          <p>
            <!--mixin labelForSymbolType(symbol)--><span class="label label-info radius ctx-type">method</span><span>pub.getControllers()</span><span title="return value" class="glyphicon glyphicon-arrow-right"></span><span>Object</span>
          </p>
        </section>
        <tabset>
          <tab heading="Description">
            <div class="well"><p>Returns controllers with their actions</p>
            </div>
          </tab>
          <tab heading="Source">
            <div hljs="hljs">pub.getControllers = function () {
        return controllers;
    };
            </div>
          </tab>
        </tabset>
        <hr/>
        <section id="addController">
          <h1>addController</h1>
          <h5 class="subheader"></h5>
          <p>
            <!--mixin labelForSymbolType(symbol)--><span class="label label-info radius ctx-type">method</span><span>pub.addController()</span>
          </p>
        </section>
        <div class="bs-example">
          <table class="table">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>controller</td>
                <td>String</td>
                <td>The path to the controller file</td>
              </tr>
              <tr>
                <td>controllerPath</td>
                <td>String</td>
                <td>The path to which the controller functions are saved in the list</td>
              </tr>
              <tr>
                <td>args</td>
                <td>Object</td>
                <td>The args to require a controller file</td>
              </tr>
            </tbody>
          </table>
        </div>
        <tabset>
          <tab heading="Description">
            <div class="well"><p>Adds a controller or controller file to the controllers list</p>
            </div>
          </tab>
          <tab heading="Source">
            <div hljs="hljs">pub.addController = function (controller, controllerPath, args) {
        controllerPath = PATH_API + controllerPath;

        if (controllerPath[controllerPath.length - 1] === '/') {
            controllerPath = controllerPath.slice(0, -1);
        }

        if (!lxHelpers.isObject(controller)) {
            if (fs.existsSync(controller)) {
                // init controller
                controller = require(controller)(args);
            } else {
                return;
            }
        }

        // init
        controllers[controllerPath] = {};

        lxHelpers.forEach(controller, function (action, functionName) {
            var params = getParamNames(action);

            // check signature of params of function
            if (params.length === 3 &amp;&amp; params[0] === 'data' &amp;&amp; params[1] === 'request' &amp;&amp; params[2] === 'callback') {
                // store in list
                controllers[controllerPath][functionName] = action;
            }
        });

        // remove when no action available
        if (Object.keys(controllers[controllerPath]).length === 0) {
            delete controllers[controllerPath];
        }
    };
            </div>
          </tab>
        </tabset>
        <hr/>
        <section id="processRequest">
          <h1>processRequest</h1>
          <h5 class="subheader"></h5>
          <p>
            <!--mixin labelForSymbolType(symbol)--><span class="label label-info radius ctx-type">method</span><span>pub.processRequest()</span>
          </p>
        </section>
        <div class="bs-example">
          <table class="table">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>req</td>
                <td>Object</td>
                <td>The request object</td>
              </tr>
              <tr>
                <td>res</td>
                <td>Object</td>
                <td>The response Object</td>
              </tr>
            </tbody>
          </table>
        </div>
        <tabset>
          <tab heading="Description">
            <div class="well"><p>Processes the rest request and calls the controller/action</p>
            </div>
          </tab>
          <tab heading="Source">
            <div hljs="hljs">pub.processRequest = function (req, res) {
        // remove trailing slash
        var route = req.originalUrl.substring(1);
        var warn;

        if (checkUserHasAccessTo(req.session.user, null, route)) {
            var parsedRoute = parseRoute(route);
            var data = req.body;
            var request = {
                sessionID: req.sessionID,
                session: req.session,
                setSession: function (callback) {
                    callback(null, true);
                },
                headers: req.headers
            };

            if (controllers[parsedRoute.controllerFullPath] &amp;&amp; controllers[parsedRoute.controllerFullPath][parsedRoute.action]) {
                controllers[parsedRoute.controllerFullPath][parsedRoute.action](data, request, function (error, result) {
                    if (error) {

                        var status = error.status || 500;

                        if (status &lt; 400) {
                            status = 500;
                        }

                        // log error
                        baboon.loggers.syslog.error(error.stack);

                        res.json(status, error);
                    }
                    else {
                        res.json(200, result);
                    }
                });
            }
            else {

                // warning
                warn = {
                    message: 'Wrong url',
                    status: 404,
                    route: parseRoute(route),
                    reqBody: req.body,
                    reqHeaders: req.headers
                };

                // log warning
                baboon.loggers.syslog.warn(warn);

                res.json(warn.status, warn.message);
            }
        } else {

            // warning
            warn = {
                message: 'Access denied',
                status: 403,
                route: parseRoute(route),
                reqBody: req.body,
                reqHeaders: req.headers
            };

            // log warning
            baboon.loggers.syslog.warn(warn);

            res.json(warn.status, warn.message);
        }
    };
            </div>
          </tab>
        </tabset>
        <hr/>
        <section id="registerSocketEvents">
          <h1>registerSocketEvents</h1>
          <h5 class="subheader"></h5>
          <p>
            <!--mixin labelForSymbolType(symbol)--><span class="label label-info radius ctx-type">method</span><span>pub.registerSocketEvents()</span>
          </p>
        </section>
        <div class="bs-example">
          <table class="table">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>socket</td>
                <td>Object</td>
                <td></td>
              </tr>
            </tbody>
          </table>
        </div>
        <tabset>
          <tab heading="Description">
            <div class="well"><p>Registers the events on the socket</p>
            </div>
          </tab>
          <tab heading="Source">
            <div hljs="hljs">pub.registerSocketEvents = function (socket) {

        var req = socket.handshake;

        //var headers = socket.handshake.headers;
        //var cookie = headers.cookie;

        var request = {
            sessionID: req.sessionID,
            session: req.session,
            setSession: function (callback) {
                baboon.session.setSession(req.session, callback);
            },
            headers: req.headers
        };

        var registerEvents = function (acl) {
            // iterate over each controller in the acl module
            lxHelpers.forEach(controllers, function (actions, controllerName) {
                // iterate over each action in the controller
                lxHelpers.forEach(actions, function (action, actionName) {
                    var eventName = controllerName + '/' + actionName;

                    if (checkUserHasAccessTo(null, acl, eventName)) {
                        // register socket event
                        socket.on(eventName, function (data, callback) {
                            controllers[controllerName][actionName](data, request, callback);
                        });
                    }
                });
            });
        };

        if (useRightSystem) {
            // register socket events based on users acl
            registerEvents((req.session.user || {}).acl);
        } else {
            registerEvents();
        }
    };

    return pub;
};
            </div>
          </tab>
        </tabset>
        <hr/>
      </div>
    </div>
  </div>
</div>