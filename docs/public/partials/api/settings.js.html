
<div class="beige-noise">
  <div class="p-wrapper">
    <div class="container"></div>
    <div class="row">
      <div class="col-sm-12">
        <section id="exports">
          <h1>exports</h1>
          <h5 class="subheader"></h5>
          <p>
            <!--mixin labelForSymbolType(symbol)--><span class="label label-info radius ctx-type">method</span><span>module.exports()</span>
          </p>
        </section>
        <div class="bs-example">
          <table class="table">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>config</td>
                <td>!Object</td>
                <td>The config.</td>
              </tr>
              <tr>
                <td>config.mongo</td>
                <td>!Object</td>
                <td>The mongo Object with the connection strings.</td>
              </tr>
              <tr>
                <td>config.path</td>
                <td>!Object</td>
                <td>The path object with all app paths.</td>
              </tr>
              <tr>
                <td>loggers</td>
                <td>!Object</td>
                <td>The loggers object.</td>
              </tr>
              <tr>
                <td>loggers.syslog</td>
                <td>!Object</td>
                <td>The syslogger.</td>
              </tr>
              <tr>
                <td>rights</td>
                <td>!Object</td>
                <td>The rights system object.</td>
              </tr>
            </tbody>
          </table>
        </div>
        <tabset>
          <tab heading="Description">
            <div class="well"><p>Returns the settings module.</p>
            </div>
          </tab>
          <tab heading="Source">
            <div hljs="hljs">module.exports = function (config, loggers, rights) {
    var pub = {};
    var settingsFolder = require('path').join(config.path.appFolder, 'settings');
            </div>
          </tab>
        </tabset>
        <hr/>
        <section id="saveSettingsToFile">
          <h1>saveSettingsToFile</h1>
          <h5 class="subheader"></h5>
          <p>
            <!--mixin labelForSymbolType(symbol)--><span class="label label-info radius ctx-type">function</span><span>saveSettingsToFile()</span>
          </p>
        </section>
        <div class="bs-example">
          <table class="table">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>user</td>
                <td>!Object</td>
                <td>The user object.</td>
              </tr>
              <tr>
                <td>settings</td>
                <td>Object</td>
                <td>The settings object.</td>
              </tr>
              <tr>
                <td>?Object=)}</td>
                <td>function(?Object=,</td>
                <td>callback The callback.</td>
              </tr>
            </tbody>
          </table>
        </div>
        <tabset>
          <tab heading="Description">
            <div class="well"><p>Saves the settings of the user in the file system.</p>
            </div>
          </tab>
          <tab heading="Source">
            <div hljs="hljs">function saveSettingsToFile (user, settings, callback) {
        // save settings in file system (file is named after the user name, e.g. guest.json)
        var fs = require('fs');
        var path = require('path');

        async.waterfall([
            function (next) {
                fs.exists(settingsFolder, function (result) {
                    next(null, result);
                });
            },
            function (folderExists, next) {
                if (!folderExists) {
                    fs.mkdir(settingsFolder, next);
                } else {
                    next();
                }
            },
            function (next) {
                fs.writeFile(path.join(settingsFolder, user.name + '.json'), JSON.stringify(settings), next);
            }
        ], function (error) {
            callback(error, true);
        });
    }
            </div>
          </tab>
        </tabset>
        <hr/>
        <section id="getUserSettings">
          <h1>getUserSettings</h1>
          <h5 class="subheader"></h5>
          <p>
            <!--mixin labelForSymbolType(symbol)--><span class="label label-info radius ctx-type">method</span><span>pub.getUserSettings()</span>
          </p>
        </section>
        <div class="bs-example">
          <table class="table">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>user</td>
                <td>!Object</td>
                <td>The user object.</td>
              </tr>
              <tr>
                <td>?Object=)}</td>
                <td>function(?Object=,</td>
                <td>callback The callback.</td>
              </tr>
            </tbody>
          </table>
        </div>
        <tabset>
          <tab heading="Description">
            <div class="well"><p>Returns the settings of the current user.</p>
            </div>
          </tab>
          <tab heading="Source">
            <div hljs="hljs">pub.getUserSettings = function (user, callback) {
        // check params
        if (!lxHelpers.isObject(user)) {
            return callback(lxHelpers.getTypeError('user', user, {}));
        }

        if (config.rights.enabled) {
            // get settings from db
            var repo = rights.getRepositories().users;

            repo.findOneById(user._id, {fields: ['settings']}, function (error, result) {
                if (!result) {
                    loggers.syslog.warn('settings: user not found: %j', user);
                    result = {};
                }

                callback(error, result.settings || {});
            });
        } else {
            // get settings from json file
            require('fs').readFile(require('path').join(settingsFolder, user.name + '.json'), {encoding: 'utf-8'}, function (error, result) {
                try {
                    var settings = JSON.parse(result || '{}');
                    callback(null, settings);
                }
                catch (e) {
                    loggers.syslog.warn('settings: Cannot parse settings file: %s', require('path').join(settingsFolder, user.name + '.json'));
                    callback(null, {});
                }
            });
        }
    };
            </div>
          </tab>
        </tabset>
        <hr/>
        <section id="getUserSettingsFromRequest">
          <h1>getUserSettingsFromRequest</h1>
          <h5 class="subheader"></h5>
          <p>
            <!--mixin labelForSymbolType(symbol)--><span class="label label-info radius ctx-type">method</span><span>pub.getUserSettingsFromRequest()</span>
          </p>
        </section>
        <div class="bs-example">
          <table class="table">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>request</td>
                <td>!Object</td>
                <td>The request object.</td>
              </tr>
              <tr>
                <td>?Object=)}</td>
                <td>function(?Object=,</td>
                <td>callback The callback.</td>
              </tr>
            </tbody>
          </table>
        </div>
        <tabset>
          <tab heading="Description">
            <div class="well"><p>Returns the settings of the user of the current request.</p>
            </div>
          </tab>
          <tab heading="Source">
            <div hljs="hljs">pub.getUserSettingsFromRequest = function (request, callback) {
        if (!lxHelpers.isObject(request) || !lxHelpers.isFunction(request.getSession)) {
            return callback(new TypeError('Param request is missing or has no function getSession()'));
        }

        async.waterfall([
            function (next) {
                request.getSession(next);
            },
            function (req, next) {
                pub.getUserSettings(req.user, next);
            }
        ], callback);
    };
            </div>
          </tab>
        </tabset>
        <hr/>
        <section id="setUserSetting">
          <h1>setUserSetting</h1>
          <h5 class="subheader"></h5>
          <p>
            <!--mixin labelForSymbolType(symbol)--><span class="label label-info radius ctx-type">method</span><span>pub.setUserSetting()</span>
          </p>
        </section>
        <div class="bs-example">
          <table class="table">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>user</td>
                <td>!Object</td>
                <td>The user object.</td>
              </tr>
              <tr>
                <td>string,</td>
                <td>!key:</td>
                <td>value: *}} setting The setting to save.</td>
              </tr>
              <tr>
                <td>?Object=)}</td>
                <td>function(?Object=,</td>
                <td>callback The callback.</td>
              </tr>
            </tbody>
          </table>
        </div>
        <tabset>
          <tab heading="Description">
            <div class="well"><p>Saves a single setting for the current user.</p>
            </div>
          </tab>
          <tab heading="Source">
            <div hljs="hljs">pub.setUserSetting = function (user, setting, callback) {
        // check params
        if (!lxHelpers.isObject(user)) {
            return callback(lxHelpers.getTypeError('user', user, {}));
        }

        if (!lxHelpers.isObject(setting) || !lxHelpers.isString(setting.key)) {
            return callback(new TypeError('Param setting is missing or has no/wrong property key'));
        }

        if (config.rights.enabled) {
            // save settings in db
            var repo = rights.getRepositories().users;

            repo.findOneById(user._id, {fields: ['settings']}, function (error, result) {
                if (error) {
                    return callback(error);
                }

                if (result) {
                    result.settings = result.settings || {};
                    result.settings[setting.key] = setting.value;

                    repo.update({_id: user._id}, {$set: {settings: result.settings}}, callback);
                } else {
                    callback(null, {});
                }
            });
        } else {
            // get current settings from json file
            pub.getUserSettings(user, function (error, result) {
                // add the new setting
                result[setting.key] = setting.value;

                // save settings
                saveSettingsToFile(user, result, callback);
            });
        }
    };
            </div>
          </tab>
        </tabset>
        <hr/>
        <section id="setUserSettingFromRequest">
          <h1>setUserSettingFromRequest</h1>
          <h5 class="subheader"></h5>
          <p>
            <!--mixin labelForSymbolType(symbol)--><span class="label label-info radius ctx-type">method</span><span>pub.setUserSettingFromRequest()</span>
          </p>
        </section>
        <div class="bs-example">
          <table class="table">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>request</td>
                <td>!Object</td>
                <td>The request object.</td>
              </tr>
              <tr>
                <td>string,</td>
                <td>!key:</td>
                <td>value: *}} setting The setting to save.</td>
              </tr>
              <tr>
                <td>?Object=)}</td>
                <td>function(?Object=,</td>
                <td>callback The callback.</td>
              </tr>
            </tbody>
          </table>
        </div>
        <tabset>
          <tab heading="Description">
            <div class="well"><p>Saves a single setting for the user of the current request.</p>
            </div>
          </tab>
          <tab heading="Source">
            <div hljs="hljs">pub.setUserSettingFromRequest = function (request, setting, callback) {
        // check params
        if (!lxHelpers.isObject(request) || !lxHelpers.isFunction(request.getSession)) {
            return callback(new TypeError('Param request is missing or has no function getSession()'));
        }

        async.waterfall([
            function (next) {
                request.getSession(next);
            },
            function (req, next) {
                pub.setUserSetting(req.user, setting, next);
            }
        ], callback);
    };
            </div>
          </tab>
        </tabset>
        <hr/>
        <section id="setUserSettings">
          <h1>setUserSettings</h1>
          <h5 class="subheader"></h5>
          <p>
            <!--mixin labelForSymbolType(symbol)--><span class="label label-info radius ctx-type">method</span><span>pub.setUserSettings()</span>
          </p>
        </section>
        <div class="bs-example">
          <table class="table">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>user</td>
                <td>!Object</td>
                <td>The user object.</td>
              </tr>
              <tr>
                <td>string,</td>
                <td>!key:</td>
                <td>value: *}} settings The settings object.</td>
              </tr>
              <tr>
                <td>?Object=)}</td>
                <td>function(?Object=,</td>
                <td>callback The callback.</td>
              </tr>
            </tbody>
          </table>
        </div>
        <tabset>
          <tab heading="Description">
            <div class="well"><p>Saves the settings for the current user.</p>
            </div>
          </tab>
          <tab heading="Source">
            <div hljs="hljs">pub.setUserSettings = function (user, settings, callback) {
        // check params
        if (!lxHelpers.isObject(user)) {
            return callback(lxHelpers.getTypeError('user', user, {}));
        }

        if (!lxHelpers.isObject(settings)) {
            return callback(new TypeError('Param setting is missing'));
        }

        if (config.rights.enabled) {
            // save settings in db
            var repo = rights.getRepositories().users;
            repo.update({_id: user._id}, {$set: {settings: settings}}, callback);
        } else {
            // save settings in file system (file is named after the user name, e.g. guest.json)
            saveSettingsToFile(user, settings, callback);
        }
    };
            </div>
          </tab>
        </tabset>
        <hr/>
        <section id="setUserSettingsFromRequest">
          <h1>setUserSettingsFromRequest</h1>
          <h5 class="subheader"></h5>
          <p>
            <!--mixin labelForSymbolType(symbol)--><span class="label label-info radius ctx-type">method</span><span>pub.setUserSettingsFromRequest()</span>
          </p>
        </section>
        <div class="bs-example">
          <table class="table">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>request</td>
                <td>!Object</td>
                <td>The request object.</td>
              </tr>
              <tr>
                <td>string,</td>
                <td>!key:</td>
                <td>value: *}} settings The settings object.</td>
              </tr>
              <tr>
                <td>?Object=)}</td>
                <td>function(?Object=,</td>
                <td>callback The callback.</td>
              </tr>
            </tbody>
          </table>
        </div>
        <tabset>
          <tab heading="Description">
            <div class="well"><p>Saves the settings for the user of the current request.</p>
            </div>
          </tab>
          <tab heading="Source">
            <div hljs="hljs">pub.setUserSettingsFromRequest = function (request, settings, callback) {
        // check params
        if (!lxHelpers.isObject(request) || !lxHelpers.isFunction(request.getSession)) {
            return callback(new TypeError('Param request is missing or has no function getSession()'));
        }

        async.waterfall([
            function (next) {
                request.getSession(next);
            },
            function (req, next) {
                pub.setUserSettings(req.user, settings, next);
            }
        ], callback);
    };

    return pub;
};
            </div>
          </tab>
        </tabset>
        <hr/>
      </div>
    </div>
  </div>
</div>